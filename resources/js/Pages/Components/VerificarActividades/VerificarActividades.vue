<template>
  <div class="wrapper">
   <!-- Navbar -->
    <Base>
      <template v-slot:header></template>
    </Base> 

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 class="m-0">Verificación de actividades</h1>
            </div><!-- /.col -->          
          </div><!-- /.row -->
        </div><!-- /.container-fluid -->
      </div><!-- /.content-header -->

      <!-- Main content -->
      <div  v-if="actividadesFiltradas.length != 0">
      <section class="content">
        <div class="container-fluid">
          <!-- Main row -->
          <div class="row">
            <!-- Left col -->
            <section class="col-lg-12 connectedSortable">
              <!-- TO DO List -->
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">
                    <i class="ion ion-clipboard mr-1"></i>
                      Lista de Actividades de los estudiantes
                  </h3>
                  <br>
                  
                  <!--Boton para finalizar actividades-->
                  <div class="col">
                    <div class="form-group">
                      <inertia-link type="button" class="btn btn-success float-left mt-2" :href="route('finalizaractividades.index')">
                        <i class="fa fa-check-square"></i> Finalizar Actividades
                      </inertia-link>
                    </div>
                  </div>
                </div>
                <!-- /.card-header -->
                <div v-if="proyectosFiltradas.length != 0">
                <div class="card-body" v-for="(proyecto, index) in proyectosFiltradas" :key="index">
                  <ul class="todo-list" data-widget="todo-list">
                    <li>
                      <h5 class="mt-2 ml-3" style="margin-bottom: 0.2rem;">{{ proyecto.nombre_peticion }}</h5>
                      <p class="ml-4 mb-1 text-gray" >Tipo Servicio: {{ proyecto.nombre_tipo_servicio }}</p>
                      <p class="ml-4 mb-4 text-gray" >Institución: {{ proyecto.nombre_institucion }}</p>
                      <!--Tabla donde apareceran todos las actividades-->
                      <div v-if="actividadesFiltradas.length != 0">
                      
                      <table class="table table-hover text-center" width="500" style="font-size: 20px">
                        <thead class="thead-dark">
                          <tr>
                            <th scope="col">Estudiante</th>
                            <th scope="col">Actividad</th>
                            <th scope="col">Fecha actividad</th>
                            <th scope="col">Acción</th>
                          </tr>
                        </thead>

                        <tbody>
                          <tr class="table-secondary" scope="row" v-for="(actividad, index) in actividadesFiltradas" :key="index">
                            <!--Aqui devuelven los datos que se mostraran en pantalla -->
                            <td v-if="proyecto.idServicio == actividad.idServicio">{{ actividad.nombre_estudiante }} {{ actividad.nombre_estudiante }}</td>
                            <td v-if="proyecto.idServicio == actividad.idServicio">{{ actividad.nombre_actividad }}</td>
                            <td v-if="proyecto.idServicio == actividad.idServicio">{{ actividad.fecha_actividad }}</td>
                            <td v-if="proyecto.idServicio == actividad.idServicio">
                              <div class="flex justify-center">      
                                <!--boton verificar-->
                                <button class="btn btn-primary" v-on:click="mostrarDatos(actividad)" data-toggle="modal" data-target="#verificar">
                                  <i class="fa fa-glasses"></i> &nbsp; <strong> Verificar </strong>
                                </button>
                              </div>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                      </div>
                      <div v-else class="alert alert-warning ml-4 mr-4 mt-3" role="alert" style="color: #856404; background-color: #fff3cd; border-color: #ffeeba;">
                          No se han encontrado datos
                      </div>
                    </li>
                  </ul>
                </div>  
                </div>
                <div v-else class="alert alert-warning ml-4 mr-4 mt-3" role="alert" style="color: #856404; background-color: #fff3cd; border-color: #ffeeba;">
                    No se han encontrado datos
                </div>


              </div>
            </section><!-- /.Left col -->
          </div><!-- /.row (main row) -->
        </div><!-- /.container-fluid -->
      </section><!-- /.content -->
      </div>
      <div v-else class="alert alert-warning ml-4 mr-4 mt-3" role="alert" style="color: #856404; background-color: #fff3cd; border-color: #ffeeba;">
        No se han encontrado datos
      </div>
    </div><!-- /.content-wrapper -->
  </div>

  <!-- Modal para la verificación de las actividades de los estudiantes-->
  <div class="modal fade" id="verificar" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <!--Contenido de la modal-->
      <div class="modal-content">
        <!--Encabezado de la modal-->
        <div class="modal-header">
          <!--Título de la modal-->
          <h5 class="modal-title" id="exampleModalLabel">Información General de la Actividad</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div><!--Fin del encabezado-->
        <!--Cuerpo de la modal-->
        <div class="modal-body">
          <div class="card-body">
            <table class="">
              <tr>
                <td><h5 class=""><strong>Estudiante: </strong></h5></td>
                <td><h5>{{ form.nombre_estudiante }} {{ form.apellido_estudiante }}</h5></td>
              </tr>
              <tr>
                <td><h5 class=""><strong>Nombre de la actividad: </strong></h5></td>
                <td><h5>{{ form.nombre_actividad }}</h5></td>
              </tr>
              <tr>
                <td><h5 class=""><strong>Fecha de la actividad: </strong></h5></td>
                <td><h5>{{ form.fecha_actividad }}</h5></td>
              </tr>
              <tr>
                <td><h5 class=""><strong>Total de horas en la actividad: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</strong></h5></td>
                <td><h5>{{ form.total_horas }}</h5></td>
              </tr>
              <tr>
                <td><h5><strong>Estado de actividad:</strong></h5></td>
                <td>
                <h5><strong>
                  <button v-if="form.verificado == 'En espera'" class="btn btn-info" style="cursor: default;" disabled>
                    <i class="far fa-clock"></i> &nbsp; <strong> En espera </strong>
                  </button>
                </strong></h5>
                </td>
              </tr>
            </table>
          </div><!-- Fin card body-->

          <!--Sección de botones-->
          <div class="card-footer clearfix">
            <div class="d-flex justify-content-center align-items-baseline">
              <!--Fila de los botones-->
              <div class="row">
                <!--Primera columna-->
                <div class="col">
                  <!--boton de verificación de actividad-->
                  <inertia-link class="btn btn-warning" title="Verificar actividad" method="put" :href="route('verificaractividades.update', this.form)" v-on:click="verificacion(form)"> 
                    <i class="fas"></i>Aceptar
                  </inertia-link>
                </div><!--Fin primera columna-->

                <!--Segunda columna-->
                <div class="col">
                  <!--boton de reportar actividad-->
                  <inertia-link class="btn btn-danger" title="Verificar actividad" method="delete" :href="route('verificaractividades.destroy', this.form)" v-on:click="Reportar(form)"> 
                    <i class="fas"></i>Reportar 
                  </inertia-link>
                  <!--<button v-else class="btn btn-danger float-center" title="Verificar actividad" v-on:click="Reportar(form)">
                    <i class="fas"></i>Reportar
                  </button>-->
                </div><!--Fin Segunda columna-->

                <!--Tercera columna-->
                <div class="col">
                  <!--boton atras-->
                  <button :href="route('verificaractividades.index')" class="btn btn-dark float-center" title="Atras" data-dismiss="modal">
                    <i class="fas"></i>Atrás
                  </button>
                </div><!--Fin Tercera columna-->
              </div><!--Fin de la fila de los botones-->
            </div>
          </div>
          <!--Fin de sección de botones-->
        </div><!--Fin cuerpo de la modal-->
      </div><!--Fin contenido de la modal-->
    </div>
  </div>

</template>

<script>
    import JetNavLink from '@/Jetstream/NavLink'
    import JetDropdownLink from '@/Jetstream/DropdownLink'
    import JetInput from '@/Jetstream/Input'
    import JetLabel from '@/Jetstream/Label'
    import JetButton from '@/Jetstream/Button'
    import Label from '../../../Jetstream/Label.vue'
    import Button from '../../../Jetstream/Button.vue'

    import Base from "@/Pages/Base.vue";

    export default {
        components:{
            JetNavLink,
            JetDropdownLink,
            JetInput,
            JetLabel,
            //JetButton,
            Base
        },
        props:['actividades', 'proyectos'],
        methods:{
            logout() {
                this.$inertia.post(route('logout'));
            },

            filtrarByActividad(id){
                this.actividadesFiltradas.splice(0, this.actividadesFiltradas.length);
                console.log(id);
                this.actividades.forEach(element => {
                    if(element.bitacora_id == id){
                        console.log(element);
                        this.actividadesFiltradas.push(element);
                    }
                });
                console.log(this.actividadesFiltradas);
                if(id == '0'){
                    this.actividades.forEach(element => {
                        this.acividadesFiltradas.push(element);
                        // this.mostrarMensajeSuccess();
                    })     
                }
            },
          
          //Metodo para la verificación de la actividad
            verificacion(actividad){
              if(actividad.verificado == 'En espera'){
                Swal.fire({
                  title:'¿Está seguro que desea dar por verificada la actividad?',
                  text: "Código " + actividad.id + " Nombre de actividad" + actividad.nombre_actividad,
                  icon:'warning',
                  showCancelButton: true,
                  confirmButtonColor: '#3085d6',
                  cancelButtonColor: '#d33',
                  confirmButtonText: 'Si, dar por verificada',
                  cancelButtonText: 'No, cancelar'
                }).then((result)=>{
                  if(result.isConfirmed){
                    this.$inertia.put(route('verificaractividades.update', actividad.id), this.formUp);
                    Swal.fire(
                      '!Verificada',
                      'La actividad a sido verificada correctamente',
                      'success'
                    );
                    window.location.reload(true);
                  }
                })
              }
            },

            // Método para reportar la actividad
            Reportar(actividad){
              if(actividad.verificado == 'En espera'){
                Swal.fire({
                  title:'¿Está seguro que desea reportar la actividad?',
                  text: "Código " +actividad.id + " Nombre de actividad " +actividad.nombre_actividad,
                  icon:'warning',
                  showCancelButton: true,
                  confirmButtonColor: '#3085d6',
                  cancelButtonColor: '#d33',
                  confirmButtonText: 'Aceptar',
                  cancelButtonText: 'No, cancelar'
                }).then((result)=>{
                  if(result.isConfirmed){
                    //this.$inertia.put(route('verificaractividades.destroy', actividad.id), this.formUp);
                    Swal.fire(
                      '!Reportada',
                      'La actividad ha sido reportada correctamente',
                      'success'
                    );
                    window.location.reload(true);
                  }
                })
              }
            },

            //carga informacion de la actividad seleccionada al formulario del modal
            mostrarDatos(actividad){
              this.form.id = actividad.id,
              this.form.nombre_estudiante = actividad.nombre_estudiante,
              this.form.apellido_estudiante = actividad.apellido_estudiante,
              this.form.nombre_actividad = actividad.nombre_actividad,
              this.form.fecha_actividad = actividad.fecha_actividad,
              this.form.total_horas = actividad.total_horas,
              this.form.verificado = actividad.verificado
            }
    },    
      
    data(){
        return{
          actividad:0,
          actividadesFiltradas:[],
          proyectosFiltradas:[],
          successGuardado:false,
          //formularioNuevaCarrera:false,
          form: this.$inertia.form({
            id:'',
            nombre_actividad:'',
            fecha_actividad:'',
            total_horas:'',
            verificado:'En espera',
            nombre_estudiante: '',
            apellido_estudiante: ''
          }),
          formUp: this.$inertia.form({
            id:'',
            nombre_actividad:'',
            fecha_actividad:'',
            total_horas:'',
            verificado:'En espera',
          }),
        }
    },        
    
    mounted(){
      this.proyectos.forEach(element => {
        this.proyectosFiltradas.push(element);
      }),
      this.actividades.forEach(element => {
        this.actividadesFiltradas.push(element);
      }),
      // this.mostrarMensajeSuccess();
      this.successGuardado = false;        
    },
  }
</script>